language: python
python: 3.5
sudo: required
dist: trusty
services: docker
osx_image: xcode6.4

env:
  global:
      - RC=rc2
      - VERSION=2.5.0
      - STAGING=https://dist.apache.org/repos/dist/dev/beam/${VERSION}/
      - ZIP_FILE=apache-beam-${VERSION}-python.zip

      - PLAT=x86_64
      - WHEELHOUSE_UPLOADER_USERNAME=pabloem
      - BUILD_DEPENDS="Cython"
      - TEST_DEPENDS=
      # Following generated with
      # travis encrypt -r robertwb/apache-beam-wheels WHEELHOUSE_UPLOADER_SECRET=$WHEELHOUSE_UPLOADER_SECRET

      - secure: "CfR8z2UDQsemm3Md6XzyoofX9kPFwy5RklaMHzEv7FyGxm3AF1ylJi5RvnEwJ4PDTBH5f5HCIzZppBhDa4nJZw5YMY4mP1msRB8e30e6kpi+5IDIM9efJQWWR48S8RwyBaM+KN45Vgeo3mY130AlbnlPGvNT+FgerKU3kwx1FO28Vvnd1kSTNhv+TMmzMWpPVBIvB/aFigOdBfBRe6nYMYh7BxbmMtUehGQ4Dt1e2OODdkEjQsmZzEqGOKgA5kkkqspVIky0m3mED20ZPD9Lg5303I8uwL39C5B5Lbj2QpX2ybXG4dmmEjqPkHApUuCcuk++pktSVSg2vN2zC6+p8zEtdR5LFZ5mCD19yAZjVfL2tZ5blm+ejGJRzjq8PHCNJqAtWI5uSVosnKQn6Rgp0xUE+bvo3cAKoi6kGtLFFrqokaKYCFyTZhp8mbTbATwX0fwch0H5enYDhM7XNDJLiDmaIkyyHLf6pF5hMSEX6x7xv+mm6FGnHp2X8Bl73nU0ncqCkCE9QLDt27crHJ9gdw2vSdrX5fLtPytEWkydtVCaTgpiW7crYF5p4zUxU7cXc1YMIXFQZlCDjU9SUvfTVF3bCjook1dxnuZxYpHSLYPyp7Hw2G2D/FOlvXsyTc37TaWFsCJdRhyT5Qgdya8M6lVKTnww4swjkQFvT330g8s="

matrix:
  exclude:
    # Exclude the default Python 3.5 build
    - python: 3.5
  include:
   - os: osx
     language: generic
     env:
       - MB_PYTHON_VERSION=2.7
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
       - UNICODE_WIDTH=16
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
       - PLAT=i686
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
       - PLAT=i686
       - UNICODE_WIDTH=16

before_install:
    - source multibuild/common_utils.sh
    - source multibuild/travis_steps.sh
    - before_install

install:
    - wget $STAGING/$ZIP_FILE
    - unzip $ZIP_FILE

script:
    - build_wheel apache-beam-${VERSION} $PLAT

after_success:
    - TRAVIS_BUILD_DIR=.
    - ls -lh ${TRAVIS_BUILD_DIR}/wheelhouse/
    - pip install twine
    - pip install pyOpenSSL ndg-httpsclient pyasn1
    # Even the test pipy won't let you re-upload a pacakge under the same name.
    - |
      for artifact in ${TRAVIS_BUILD_DIR}/wheelhouse/*.*; do
          mv $artifact ${artifact/$VERSION/$VERSION.$RC};
      done
    - source deploy_travis.sh
    - deploy
