
language: python
python: 3.5
sudo: required
dist: trusty
services: docker
osx_image: xcode6.4

env:
  global:
      - RC=rc1
      - VERSION=2.6.0
      - PYTHON_ARTIFACTS_DIR=python
      - STAGING=https://dist.apache.org/repos/dist/dev/beam/${VERSION}/${PYTHON_ARTIFACTS_DIR}
      - BEAM_SVN_DIR=https://dist.apache.org/repos/dist/dev/beam
      - ZIP_FILE=apache-beam-${VERSION}.zip

      - PLAT=x86_64
      - WHEELHOUSE_UPLOADER_USERNAME=pabloem
      - BUILD_DEPENDS="Cython"
      - TEST_DEPENDS=
      # Following generated with
      # travis encrypt -r robertwb/apache-beam-wheels WHEELHOUSE_UPLOADER_SECRET=$WHEELHOUSE_UPLOADER_SECRET
      - secure: "Ab5HEYCDkIURjzOtJGcsjSXOOLKa2sHSI9m00K02rU7O8hgTJH4AxW7kLLDlfk8LwdjQZ47lBzS6XcbtF5/wIwn8In8gxzgNpP4/BCY661tFTw8HS7+Ar7tNYB8NN5wFgHVmjSE4yafkOqjRoq8YqKVlORVuKqRTyyQ0sgNHgMtv837wPV/SA5D44QRMDZXIwIGY934PJL4Z1gatgZde4ts61Vk2EHGVV/lPylD6si1Ir1Bm2/RdPSJh424B5fpbO1zvHE0Ixb9qjQtQuogS6jX8ywazFaKFYpkOfiy7+3u9mtsHcQYZ/gJ3g4wGQxeTKb+9Ijv4VPI4+ypbuKwckLjWK7GGfrngP/+TSh+Tzwnuojw4O0xN2TLiA/3h6zXBUdl2MOL3lvn49UExXmNS0+W6YBnsL1kWI7vXwidhi8HVuvDBwN57a63i34CIyutq8GQK12szTZEzJQZrcfzM7Ntxc1dw2FaJB2Mi8GuoM3k9ktsvD1yc86peiB6pvfH1Q5CBGZpoGGWLa6XAd8KMkAuQDZN5KazWmNWwaqpSIC/L21hFkorixT2f251gdG3P2rrNoKJNYXt0DYYW0hjyp74qgI1IIAbpjZoNgeJPwgb+47WyirLeH5JyyQi9kAfic2LcX6ce2Pm3HKxFLZd72eBVSDOqtjlKLZ8iYc61Uvc="


matrix:
  exclude:
    # Exclude the default Python 3.5 build
    - python: 3.5
  include:
   - os: osx
     language: generic
     env:
       - MB_PYTHON_VERSION=2.7
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
       - UNICODE_WIDTH=16
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
       - PLAT=i686
   - os: linux
     env:
       - MB_PYTHON_VERSION=2.7
       - PLAT=i686
       - UNICODE_WIDTH=16

before_install:
    - source multibuild/common_utils.sh
    - source multibuild/travis_steps.sh
    - before_install

install:
    - wget $STAGING/$ZIP_FILE
    - unzip $ZIP_FILE

script:
    - build_wheel apache-beam-${VERSION} $PLAT

after_success:
    - ls -lh ${TRAVIS_BUILD_DIR}/wheelhouse/
    # Even the test pipy won't let you re-upload a pacakge under the same name.
    - |
      for artifact in ${TRAVIS_BUILD_DIR}/wheelhouse/*.*; do
          mv $artifact ${artifact/$VERSION/$VERSION.$RC};
      done
    - source deploy_travis.sh
    - deploy